public class UsernamePasswordFlowController {
    
    public Static String zipfile{set;get;}
    public String body{set;get;}
   
    @future
    public static void getAuthenticated(){
        String recordId  = ApexPages.currentPage().getParameters().get('recId');
        string zipId;
        if(RecordId != NULL){
			zipId=MetadataFactoryUtil.retrieve_x(RecordId);
        }
        MetadataFactory.MetadataOutlet port = getPort();       
        MetadataFactory.RetrieveResult result = port.checkRetrieveStatus(zipId, true);
        zipfile=result.zipFile;
        if(zipfile != null){
            Account acc = new Account(name='zipfile123',Unziip_File__c=zipfile);
            insert acc;
            //return zipfile;
        }
      // return 'nozip';
    }
   /* @future(callout=true)    
    public static void getAuthenticated1(){
       
        
        Http http = new Http();
        
        HttpRequest req = new HttpRequest();
        req.setEndpoint('https://star43-dev-ed.develop.my.salesforce.com/services/oauth2/token');
        req.setMethod('POST');
        req.setBody('grant_type=password&username=vignesh@star.com&password=vicky@2301g4mn2ToS3rgqpLdqozzVYDWUd&client_id=3MVG9n_HvETGhr3ChBzEyL9s3BAmXgn_9KlM0i_YLaQekJ59l4CM2Gdw7UxerrHJ22jWUv2KVhQLRgAEBScuT&client_secret=0FE9946B1AC907D504BD2C8AFAE1D0F55D4784DBA8376AF41CDF9AB615AC1E7D');
        
        HttpResponse response=http.send(req);
        system.debug('response---->'+response);
        String body = response.getbody();
        system.debug('body---->'+body);
        
        fromJSON d=(fromJSON)json.deserialize(body, fromJSON.class);
        system.debug('fromJSON d'+d);
        
        if(RecordId != NULL){
            string zipId=MetadataFactoryUtil.retrieve_x(RecordId);
            system.debug('zipId------>'+zipId);
            callStarAccount(d.access_token,zipId,true);
        }
    }
    
    @future(callout=true)
    public static void callStarAccount(string accToken,String asyncProcessId,Boolean includeZip){
        
        MetadataFactory.MetadataOutlet port = getPort();
        
        MetadataFactory.RetrieveResult result = port.checkRetrieveStatus(asyncProcessId, includeZip);
        
        System.debug('checkRetrieveStatus------>'+result.zipFile);
        System.debug('RetrieveResult status: ' + result.status);
        zipfile=result.zipFile;
        system.debug('First Load'+zipfile);
        
        if(zipfile != null){
            // Callout- Github
            String accessToken = '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';
            HttpRequest req = new HttpRequest();
            req.setMethod('PUT');
            req.setEndpoint('https://api.github.com/repos/vignesh2301/helloTask/contents/newfi.zip');
            req.setHeader('Authorization', 'Bearer ' + accessToken);
            req.setHeader('User-Agent', 'Salesforce');
            req.setHeader('Content-Type', 'application/json');
            
            Map<String, Object> requestBody = new Map<String, Object>();
            requestBody.put('message', 'Create new file');
            requestBody.put('content', EncodingUtil.base64Encode(Blob.valueOf(zipfile)));
            requestBody.put('path', 'path/to/newfile.zip');
            
            String requestBodyJson = JSON.serialize(requestBody);
            req.setBody(requestBodyJson);
            system.debug('requestBodyJson'+requestBodyJson);
            
            Http http = new Http();
            
            HttpResponse res = http.send(req);
            system.debug('res--//'+res);
        }  
        
        // Callout for external org (Star org)- Dont delete
        Http http = new Http();
        
        HttpRequest req = new HttpRequest();
        req.setEndpoint('https://star43-dev-ed.develop.my.salesforce.com/services/apexrest/Account/Contacts/');
        req.setMethod('POST');
        req.setBody('{"zipfile":"'+zipfile +'"}');
        req.setHeader('Accept', 'application/json');
        req.setHeader('Authorization','Bearer '+accToken);
        req.setHeader('Content-Type','application/json');
        
        HttpResponse response =http.send(req);
        system.debug('response--->'+response.getBody());
        
        //return result.zipFile;
    } 
    
    //Return zip string
    @AuraEnabled
    public static String getunzip(){
        system.debug('Second Load'+zipfile);
        return zipfile;
        
    }*/
    
    //Generated by AdminBooster
    
    public class fromJSON{
        public String access_token;	//00D2w00000LeXQ9!ARkAQHMMobdZgV8gUYYRF3JfpcKC6Rl5PIicV9xJHgBgdM6j4EtAZr7XlBJCMgAO9dfU1bJ0k3qDwPSuNshrnCILICsAh.Z5
        public String instance_url;	//https://star43-dev-ed.develop.my.salesforce.com
        public String id;	//https://login.salesforce.com/id/00D2w00000LeXQ9EAN/0052w00000CLeXfAAL
        public String token_type;	//Bearer
        public String issued_at;	//1675409683992
        public String signature;	//YgqEz7TxLlkh82jUATzb+bEM02PzSpHjWWl09ltzp7c=
    }
    
    @AuraEnabled
    public static MetadataFactory.MetadataOutlet getPort() {
        MetadataFactory.SessionHeader_element sheader = new MetadataFactory.SessionHeader_element();
        sheader.sessionid = UserInfo.getSessionId();
        
        MetadataFactory.AllOrNoneHeader_element aonHeader= new MetadataFactory.AllOrNoneHeader_element();
        aonHeader.allOrNone = true;
        
        MetadataFactory.MetadataOutlet port = new MetadataFactory.MetadataOutlet();
        port.SessionHeader = sheader;
        port.AllOrNoneHeader = aonHeader;
        return port;
    }  
    @AuraEnabled
    public static string getunzipFile() {
		Account acc = [SELECT Id, Name, Unziip_File__c FROM Account WHERE Id='0015j00000yKAE1AAO'];
        return acc.Unziip_File__c;
    }
}